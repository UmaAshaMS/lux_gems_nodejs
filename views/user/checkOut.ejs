<%- include('./layout/header') %>
    <%- include('./layout/navbar') %>
        <%- include('./layout/category_navbar') %>

            <div class="container my-5">
                <form id="checkoutForm" onsubmit="submitCheckout(event)">
                    <h2 class="mb-4">Checkout</h2>
                    <div class="row">
                        <!-- Left Section: Address, Coupon, Payment -->
                        <div class="col-md-6">
                            <!-- Address Section -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Delivery Address</h5>
                                    <% if (defaultAddress) { %>
                                        <p class="card-text"><strong>
                                                <%= defaultAddress.fullName %>
                                            </strong></p>
                                        <p class="card-text">
                                            <%= defaultAddress.addressLine1 %>, <%= defaultAddress.addressLine2 %>
                                        </p>
                                        <p class="card-text">
                                            <%= defaultAddress.city %>, <%= defaultAddress.state %>, <%=
                                                        defaultAddress.country %>
                                        </p>
                                        <p class="card-text">PINCODE: <%= defaultAddress.pincode %>
                                        </p>
                                        <p class="card-text">Phone Number: <%= defaultAddress.phoneNumber %>
                                        </p>
                                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal"
                                            data-bs-target="#addressModal">Change Address</button>
                                        <% } else if (selectedAddress) { %>
                                            <% const selectedAddr=userAddress.find(addr=> addr._id.toString() ===
                                                selectedAddress.toString()); %>
                                                <p class="card-text"><strong>
                                                        <%= selectedAddr.fullName %>
                                                    </strong></p>
                                                <p class="card-text">
                                                    <%= selectedAddr.addressLine1 %>, <%= selectedAddr.addressLine2 %>
                                                </p>
                                                <p class="card-text">
                                                    <%= selectedAddr.city %>, <%= selectedAddr.state %>, <%=
                                                                selectedAddr.country %>
                                                </p>
                                                <p class="card-text">PINCODE: <%= selectedAddr.pincode %>
                                                </p>
                                                <p class="card-text">Phone Number: <%= selectedAddr.phoneNumber %>
                                                </p>
                                                <% } else { %>
                                                    <p class="card-text">No default address available. Please add one.
                                                    </p>
                                                    <a href="/addAddress" class="btn btn-primary">Add Address</a>
                                                    <% } %>
                                </div>
                            </div>

                            <!-- Coupon Section -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Apply Coupon</h5>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" id="couponCode"
                                            placeholder="Enter Coupon Code">
                                        <button class="btn btn-outline-secondary" type="button"
                                            id="applyCouponBtn">Apply</button>
                                    </div>
                                    <div id="couponFeedback"></div>
                                </div>
                            </div>

                            <!-- Payment Section -->
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Payment Options</h5>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="paymentMethod"
                                            id="walletOption" value="2">
                                        <label class="form-check-label" for="walletOption">
                                            <strong>Wallet</strong> (Balance: Rs 00.00)
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="upiOption"
                                            value="1">
                                        <label class="form-check-label" for="upiOption">
                                            <strong>UPI (via PayPal)</strong>
                                        </label>
                                        <div class="mt-2">
                                            <input type="text" class="form-control" placeholder="Enter UPI ID">
                                        </div>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="codOption"
                                            value="0">
                                        <label class="form-check-label" for="codOption">
                                            <strong>Cash on Delivery (COD)</strong>
                                        </label>
                                        <p class="mb-0">Pay when your order is delivered.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Section: Order Summary -->
                        <div class="col-md-6">
                            <div class="card mb-6">
                                <div class="card-body">
                                    <h5 class="card-title">Order Summary</h5>
                                    <ul class="list-group list-group-flush">
                                        <% if (cart && cart.product && cart.product.length> 0) { %>
                                            <% cart.product.forEach(productItem=> { %>
                                                <li class="list-group-item">
                                                    <div class="d-flex justify-content-between">
                                                        <span><strong>
                                                                <%= productItem.productId.productName %>
                                                            </strong></span>
                                                        <span>Quantity: <%= productItem.quantity %></span>
                                                    </div>
                                                    <div class="d-flex justify-content-between mt-1">
                                                        <span>Original Price: <strong>Rs <%=
                                                                    productItem.productId.productPrice.toFixed(2) %>
                                                            </strong></span>
                                                        <span>Product Offer: <strong>
                                                                <%= productItem.productId.productDiscount ?
                                                                    productItem.productId.productDiscount.toFixed(2)
                                                                    : '0' %> %

                                                            </strong></span>
                                                    </div>
                                                    <div class="d-flex justify-content-between mt-1">
                                                        <span>Offer Price: <strong>Rs <%=
                                                                    (productItem.productId.productPrice -
                                                                    (productItem.productId.productDiscount /
                                                                    100)*productItem.productId.productPrice).toFixed(2)
                                                                    %></strong></span>
                                                        <span>Total: <strong>Rs <%= ((productItem.productId.productPrice
                                                                    - (productItem.productId.productDiscount / 100) *
                                                                    productItem.productId.productPrice) *
                                                                    productItem.quantity).toFixed(2) %></strong></span>
                                                    </div>
                                                </li>
                                                <% }); %>

                                                    <li class="list-group-item">
                                                        <strong>Total: Rs <%= cart.product.reduce((total, item)=> total
                                                                + ((item.productId.productPrice -
                                                                (item.productId.productDiscount / 100)) *
                                                                item.quantity), 0).toFixed(2) %></strong>
                                                    </li>
                                                    <li class="list-group-item">
                                                        <strong>Delivery Charge: </strong> Rs <%=
                                                            deliveryCharge.toFixed(2) %>
                                                            <% if (deliveryCharge===0) { %>
                                                                <span class="text-success">(Free delivery for orders
                                                                    above ₹2000)</span>
                                                                <% } else { %>
                                                                    <span class="text-warning">(Delivery charge applies
                                                                        for orders below ₹2000)</span>
                                                                    <% } %>
                                                    </li>
                                                    <li class="list-group-item">
                                                        <strong>Promotion Applied:</strong> Rs <span
                                                            id="promotionAmount">
                                                            <%= promotionAmount.toFixed(2) %>
                                                        </span>
                                                    </li>
                                                    <li class="list-group-item">
                                                        <h4 style="color:rgb(139, 12, 12)"><strong>Order Total:</strong>
                                                            Rs <span id="OrderTotal">
                                                                <%= (subtotal + deliveryCharge -
                                                                    promotionAmount).toFixed(2) %>
                                                            </span></h4>
                                                    </li>
                                                    <% } else { %>
                                                        <li class="list-group-item">Your cart is empty.</li>
                                                        <% } %>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Place Order Button -->
                    <div class="form-group text-center mt-5">
                        <button type="button" class="btn btn-black btn-lg py-3" id="placeOrderButton"
                            onclick="confirmCheckout(event)">Place Order</button>
                    </div>
                </form>
            </div>


            <input type="hidden" name="selectedAddress" id="selectedAddress"
                value="<%= defaultAddress ? defaultAddress._id : '' %>">

            <!-- Address Modal -->
            <div id="addressModal" class="modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Delivery Address</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <% if (userAddress && userAddress.address && userAddress.address.length> 0) { %>
                                <% userAddress.address.forEach((address, index)=> { %>
                                    <div class="address-item d-flex align-items-start mb-3">
                                        <input type="radio" name="address"
                                            onclick="updateSelectedAddress('<%= address._id %>')"
                                            id="modalAddress<%= address._id %>" value="<%= address._id %>" class="me-2"
                                            <%=address._id.toString()===(defaultAddress ? defaultAddress._id.toString()
                                            : '' ) ? 'checked' : '' %>>
                                        <label for="modalAddress<%= address._id %>" class="w-100">
                                            <p class="mb-1"><strong>
                                                    <%= address.fullName %>
                                                </strong></p>
                                            <p class="mb-1">
                                                <%= address.addressLine1 %>, <%= address.addressLine2 %>
                                            </p>
                                            <p class="mb-1">
                                                <%= address.city %>, <%= address.state %>, <%= address.country %>
                                            </p>
                                            <p class="mb-1">PINCODE: <%= address.pincode %>
                                            </p>
                                            <p>Phone Number: <%= address.phoneNumber %>
                                            </p>
                                        </label>
                                        <button class="ms-3" onclick="editAddress('<%= address._id %>')"
                                            data-bs-toggle="modal" data-bs-target="#editAddressModal"><i
                                                class="fas fa-edit"></i></button>
                                        <button class="ms-3" onclick="deleteAddress('<%= address._id %>')"><i
                                                class="fas fa-trash-alt"></i></button>
                                    </div>
                                    <% }); %>
                                        <% } else { %>
                                            <p>No addresses available. Please add a new address.</p>
                                            <% } %>
                                                <a href="/addAddressCheckout" class="btn">Add New Address</a>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary"
                                onclick="confirmAddressSelection()">Confirm</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Modal for Editing Address -->
            <div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editAddressForm">
                                <div class="mb-3">
                                    <label for="fullName">Full Name:</label>
                                    <input type="text" class="form-control mx-auto" id="fullName" name="fullName"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="phoneNumber">Phone Number:</label>
                                    <input type="text" class="form-control mx-auto" id="phoneNumber" name="phoneNumber"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="addressLine1" class="form-label">Address Line 1</label>
                                    <input type="text" class="form-control" id="addressLine1" name="addressLine1"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="addressLine2" class="form-label">Address Line 2</label>
                                    <input type="text" class="form-control" id="addressLine2" name="addressLine2">
                                </div>
                                <div class="mb-3">
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="city" name="city" required>
                                </div>
                                <div class="mb-3">
                                    <label for="pinCode" class="form-label">Pin Code</label>
                                    <input type="text" class="form-control" id="pinCode" name="pinCode" required>
                                </div>
                                <div class="row">
                                    <div class="form-group col-md-6">
                                        <label for="state">State:</label>
                                        <select class="form-control" id="state" name="state" required>
                                            <option value="" disabled selected>Select your state</option>
                                            <option value="Kerala">Kerala</option>
                                            <option value="Tamil Nadu">Tamil Nadu</option>
                                            <option value="Karnataka">Karnataka</option>
                                        </select>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="country">Country:</label>
                                        <select class="form-control" id="country" name="country" required>
                                            <option value="" disabled selected>Select your country</option>
                                            <option value="India">India</option>
                                        </select>
                                    </div>
                                </div>
                                <input type="hidden" id="addressId" name="addressId">
                                <!-- Hidden field to store the address ID -->
                                <button type="submit" class="btn btn-primary">Save changes</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Script for Checkout -->
            <script>
                console.log('hloo')
                const paymentOptions = document.getElementsByName('paymentMethod')
                // console.log(paymentOptions)
                const userAddress = <% - JSON.stringify(userAddress) %>;

                console.log('USER ADDRESS', userAddress)

                function updateSelectedAddress(addressId) {
                    document.getElementById("selectedAddress").value = addressId;
                }


                function confirmAddressSelection() {
                    // Get the selected address ID
                    const selectedAddressId = document.getElementById('selectedAddress').value;

                    if (!selectedAddressId) {
                        alert('Please select an address.');
                        return;
                    }

                    const addressLabel = document.querySelector(`label[for="modalAddress${selectedAddressId}"]`);
                    const cardBody = document.querySelector('.card-body');

                    cardBody.innerHTML = addressLabel.innerHTML + `<button type="button" class="btn btn-secondary mt-3" data-bs-toggle="modal" data-bs-target="#addressModal">Change Address</button>`;

                    const modalElement = document.getElementById('addressModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }


                function editAddress(addressId) {
                    const addresses = JSON.parse('<%- JSON.stringify(userAddress.address) %>');
                    console.log('ADDRESS', addresses)
                    const address = addresses.find(addr => addr._id === addressId);
                    console.log('ADDRESS of the id', address)


                    if (address) {
                        // Prefill the form fields with the user address data
                        document.getElementById('fullName').value = address.fullName || '';
                        document.getElementById('phoneNumber').value = userAddress.phoneNumber || '';
                        document.getElementById('addressLine1').value = userAddress.addressLine1 || '';
                        document.getElementById('addressLine2').value = userAddress.addressLine2 || '';
                        document.getElementById('city').value = userAddress.city || '';
                        document.getElementById('pinCode').value = userAddress.pinCode || '';
                        document.getElementById('state').value = userAddress.state || '';
                        document.getElementById('country').value = userAddress.country || '';

                        document.getElementById('addressId').value = addressId;


                        // Show the modal (Bootstrap modal)
                        const modal = new bootstrap.Modal(document.getElementById('editAddressModal'));
                        modal.show();
                    } else {
                        console.error('Address not found');
                    }
                }

                document.getElementById('editAddressForm').addEventListener('submit', function (event) {
                    event.preventDefault();

                    const addressData = {
                        id: document.getElementById('addressId').value,
                        fullName: document.getElementById('fullName').value,
                        phoneNumber: document.getElementById('phoneNumber').value,
                        addressLine1: document.getElementById('addressLine1').value,
                        addressLine2: document.getElementById('addressLine2').value,
                        city: document.getElementById('city').value,
                        pinCode: document.getElementById('pinCode').value,
                        state: document.getElementById('state').value,
                        country: document.getElementById('country').value,
                    };

                    fetch(`/admin/editAddressCheckout/${addressId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(addressData),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                updateAddressInUI(addressData);

                                const modal = bootstrap.Modal.getInstance(document.getElementById('editAddressModal'));
                                modal.hide();

                                alert('Address updated successfully!');
                            } else {
                                alert('Failed to update address: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while updating the address.');
                        });
                });

                function updateAddressInUI(addressData) {
                    const addressRow = document.getElementById(`address-${addressData.id}`);
                    if (addressRow) {
                        addressRow.querySelector('.fullName').innerText = addressData.fullName;
                        addressRow.querySelector('.phoneNumber').innerText = addressData.phoneNumber;
                        addressRow.querySelector('.addressLine1').innerText = addressData.addressLine1;
                        addressRow.querySelector('.addressLine2').innerText = addressData.addressLine2;
                        addressRow.querySelector('.city').innerText = addressData.city;
                        addressRow.querySelector('.pinCode').innerText = addressData.pinCode;
                        addressRow.querySelector('.state').innerText = addressData.state;
                        addressRow.querySelector('.country').innerText = addressData.country;
                    }
                }

                function deleteAddress(addressId) {
                    if (confirm('Are you sure you want to delete this address?')) {
                        fetch(`/admin/deleteAddressCheckout/${addressId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {

                                    alert('Address deleted successfully!');
                                } else {
                                    alert('Failed to delete address: ' + data.message);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An error occurred while deleting the address.');
                            });
                    }
                }


                document.getElementById('applyCouponBtn').addEventListener('click', async () => {
                    const couponCode = document.getElementById('couponCode').value;
                    const couponFeedback = document.getElementById('couponFeedback');

                    try {
                        // Make a POST request to apply the coupon
                        const response = await fetch('/applyCoupon', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ couponCode }),
                        });

                        const result = await response.json();

                        if (response.ok) {
                            // Update the feedback message on successful coupon application
                            couponFeedback.innerHTML = `<span class="text-success">Coupon applied successfully! Discount: ₹${result.discount.toFixed(2)}</span>`;
                            updateOrderSummary(result.totalAmount, result.discount);

                        } else {
                            // Show error message if the coupon application failed
                            couponFeedback.innerHTML = `<span class="text-danger">${result.message}</span>`;
                        }
                    } catch (error) {
                        couponFeedback.innerHTML = `<span class="text-danger">Error applying coupon. Please try again.${error}.</span>`;
                        console.error('Error applying coupon:', error);
                    }
                });

                // function updateOrderSummary(totalAmount, discount) {
                //     // Update the promotion amount
                //     const promotionAmountElement = document.getElementById('promotionAmount');
                //     if (promotionAmountElement) {
                //         promotionAmountElement.innerHTML = ` ${discount.toFixed(2)}`;
                //     }

                //     // Update the order total
                //     const orderTotalElement = document.getElementById('OrderTotal');;
                //     if (orderTotalElement) {
                //         orderTotalElement.innerHTML = ` ${totalAmount.toFixed(2)}`;
                //     }
                // }












                function confirmCheckout(event) {
                    if (event) {
                        event.preventDefault();
                        console.log('event triggered')
                    }

                    // console.log('hlooooooooooooooooooooooooooooooooooooooooooo')

                    const selectedAddressId = document.getElementById('selectedAddress').value;

                    const defaultAddress = {
                        fullName: '<%= defaultAddress.fullName %>',
                        addressLine1: '<%= defaultAddress.addressLine1 %>',
                        addressLine2: '<%= defaultAddress.addressLine2 %>',
                        city: '<%= defaultAddress.city %>',
                        state: '<%= defaultAddress.state %>',
                        country: '<%= defaultAddress.country %>',
                        pincode: '<%= defaultAddress.pincode %>',
                        phoneNumber: '<%= defaultAddress.phoneNumber %>'
                    };

                    let addressToSend;

                    if (selectedAddressId) {
                        const selectedAddress = userAddress.address.find(addr => addr._id === selectedAddressId);
                        addressToSend = {
                            fullName: selectedAddress.fullName,
                            addressLine1: selectedAddress.addressLine1,
                            addressLine2: selectedAddress.addressLine2,
                            city: selectedAddress.city,
                            state: selectedAddress.state,
                            country: selectedAddress.country,
                            pincode: selectedAddress.pincode,
                            phoneNumber: selectedAddress.phoneNumber
                        };
                    } else {
                        addressToSend = defaultAddress;
                    }

                    let paymentIsChecked = false
                    let selectedPaymentOption = 0
                    for (let i = 0; i < paymentOptions.length; i++) {
                        if (paymentOptions[i].checked) {
                            selectedPaymentOption = paymentOptions[i].value
                            paymentIsChecked = true
                            break;
                        }
                    }

                    if (!paymentIsChecked) {
                        Swal.fire({
                            title: 'Error',
                            icon: 'error',
                            text: 'Select a payment method',
                            confirmButtonText: 'OK'
                        });
                        return
                    }

                    const orderTotal = parseFloat(document.getElementById('OrderTotal').innerText);

                    //if the option is COD
                    if (parseInt(selectedPaymentOption) === 0) {
                        const URL = `/placeOrder`
                        fetch(URL, {
                            method: 'POST',
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ addressToSend, selectedPaymentOption })

                        }).then((res) => {

                            return res.json()
                        }).then((data) => {

                            if (data.success) {
                                window.location.href = `/orderConfirmed/${data.orderId}`
                            }
                            else if (data.message) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'error',
                                    text: data.message,
                                })
                            }
                        }).catch((err) => {
                            console.log(`error on paying using cod`)
                        })
                    }

                    //if the option is WALLET
                    if (parseInt(selectedPaymentOption) === 2) {
                        const URL = `/placeOrder`
                        fetch(URL, {
                            method: 'POST',
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ addressToSend, selectedPaymentOption })

                        }).then((res) => {

                            return res.json()
                        }).then((data) => {

                            if (data.success) {
                                window.location.href = `/orderConfirmed/${data.orderId}`
                            }
                            else if (data.message) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'error',
                                    text: data.message,
                                })
                            }
                        }).catch((err) => {
                            console.log(`error on paying using cod`)
                        })
                    }

                }
            </script>