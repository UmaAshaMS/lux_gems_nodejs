<%- include('./layout/header') %>
    <%- include('./layout/navbar') %>
        <%- include('./layout/category_navbar') %>

            <div class="container my-5">
                <form method="POST" action="/submitPayment">
                <h2 class="mb-4">Checkout</h2>
                <div class="row">
                    <div class="col-md-6">
                        <!-- Address Section -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Delivery Address</h5>
                                <% if (defaultAddress) { %>
                                    <p class="card-text"><strong><%= defaultAddress.fullName %></strong></p>
                                    <p class="card-text"><%= defaultAddress.addressLine1 %>, <%= defaultAddress.addressLine2 %></p>
                                    <p class="card-text"><%= defaultAddress.city %>, <%= defaultAddress.state %>,<%=defaultAddress.country %></p>
                                    <p class="card-text">PINCODE : <%= defaultAddress.pincode %></p>
                                    <p class="card-text">Phone Number : <%= defaultAddress.phoneNumber %></p>
                                    <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#addressModal">Change Address</button>
                                    
                                    <% } else if(selectedAddress){ %>
                                    <!-- Display selected address if available -->
                                    <% const selectedAddr=userAddress.find(addr=> addr._id.toString() === selectedAddress.toString()); %>
                                    <p class="card-text"><strong><%= selectedAddr.fullName %></strong></p>
                                    <p class="card-text"><%= selectedAddr.addressLine1 %>, <%= selectedAddr.addressLine2 %></p>
                                    <p class="card-text"><%= selectedAddr.city %>, <%= selectedAddr.state %>, <%=selectedAddr.country %></p>
                                    <p class="card-text">PINCODE: <%= selectedAddr.pincode %></p>
                                    <p class="card-text">Phone Number: <%= selectedAddr.phoneNumber %></p>
                                    
                                    <% } else { %>
                                    <p class="card-text">No default address available. Please add one.</p>
                                    <a href="/addAddress" class="btn btn-primary">Add Address</a>
                                    <% } %>
                            </div>
                        </div>


                        <!-- The Modal -->
                        <div id="addressModal" class="modal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Select Delivery Address</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <% if (userAddress && userAddress.address && userAddress.address.length> 0) { %>
                                            <% userAddress.address.forEach((address)=> { %>
                                                <div class="address-item d-flex align-items-start mb-3">
                                                    <!-- Checkbox for Address Selection -->
                                                    <input type="radio" name="selectedAddress"
                                                        id="modalAddress<%= address._id %>" value="<%= address._id %>"
                                                        class="me-2">

                                                    <!-- Address Details -->
                                                    <label for="modalAddress<%= address._id %>" class="w-100">
                                                        <div>
                                                            <p class="mb-1">
                                                                <strong>
                                                                    <%= address.fullName %>
                                                                </strong>
                                                            </p>
                                                            <p class="mb-1">
                                                                <%= address.addressLine1 %>, <%= address.addressLine2 %>
                                                            </p>
                                                            <p class="mb-1">
                                                                <%= address.city %>, <%= address.state %>, <%=
                                                                            address.country %>
                                                            </p>
                                                            <p class="mb-1">PINCODE: <%= address.pincode %>
                                                            </p>
                                                            <p>Phone Number: <%= address.phoneNumber %>
                                                            </p>
                                                        </div>
                                                    </label>

                                                    <!-- Edit Button -->
                                                    <button class=" ms-3" onclick="editAddress('<%= address._id %>')"><i
                                                            class="fas fa-edit"></i></button>
                                                    <button class=" ms-3" onclick="editAddress('<%= address._id %>')"><i
                                                            class="fas fa-trash-alt"></i></button>
                                                </div>
                                                <% }); %>
                                                    <% } else { %>
                                                        <p>No addresses available. Please add a new address.</p>
                                                        <% } %>
                                                            <a href="/addAddressCheckout" class="btn">Add New Address</a>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-primary"
                                            onclick="confirmAddressSelection()">Confirm</button>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Coupon Section -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Apply Coupon</h5>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" placeholder="Enter Coupon Code">
                                    <button class="btn btn-outline-secondary" type="button">Apply</button>
                                </div>
                            </div>
                        </div>

                        <!-- Order Summary Section -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Order Summary</h5>
                                <ul class="list-group list-group-flush">
                                    <% if (cart && cart.product && cart.product.length> 0) { %>
                                        <% cart.product.forEach(productItem=> { %>
                                            <li class="list-group-item">
                                                <%= productItem.productId.productName %>:
                                                    Rs <%= productItem.productId.productPrice %> x <%=
                                                            productItem.quantity %> =
                                                            Rs <%= productItem.productId.productPrice *
                                                                productItem.quantity %>
                                            </li>
                                            <% }); %>

                                                <li class="list-group-item">
                                                    <strong>Total: Rs <%= cart.product.reduce((total, item)=> total +
                                                            (item.productId.productPrice * item.quantity), 0)
                                                            %></strong>
                                                </li>
                                                <li class="list-group-item">
                                                    <strong>Delivery Charge: </strong> Rs <%= deliveryCharge.toFixed(2)
                                                        %>
                                                </li>
                                                <li class="list-group-item">
                                                    <strong>Promotion Applied : </strong> Rs <%=
                                                        promotionAmount.toFixed(2) %>
                                                </li>
                                                <li class="list-group-item">
                                                    <h4 style="color:rgb(139, 12, 12)"><strong>Order Total : </strong>
                                                        Rs <%= (subtotal + deliveryCharge - promotionAmount).toFixed(2)
                                                            %>
                                                    </h4>
                                                </li>

                                                <% } else { %>
                                                    <li class="list-group-item">Your cart is empty.</li>
                                                    <% } %>
                                </ul>

                            </div>
                        </div>
                    </div>

                    <!-- Right Side: Payment Method -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Payment Options</h5>
                                

                                <!-- Payment Options -->
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="walletOption"
                                        value="0">
                                    <label class="form-check-label" for="walletOption">
                                        <strong>Wallet</strong> (Balance: Rs 50.00)
                                    </label>
                                </div>



                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                        id="debitCardOption">
                                    <label class="form-check-label" for="debitCardOption">
                                        <strong>Debit Card</strong>
                                    </label>
                                    <div class="mt-2">
                                        <input type="text" class="form-control mb-2" placeholder="Card Number">
                                        <input type="text" class="form-control mb-2" placeholder="Expiry Date (MM/YY)">
                                        <input type="text" class="form-control mb-2" placeholder="CVV">
                                    </div>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                        id="creditCardOption">
                                    <label class="form-check-label" for="creditCardOption">
                                        <strong>Credit Card</strong>
                                    </label>
                                    <div class="mt-2">
                                        <input type="text" class="form-control mb-2" placeholder="Card Number">
                                        <input type="text" class="form-control mb-2" placeholder="Expiry Date (MM/YY)">
                                        <input type="text" class="form-control mb-2" placeholder="CVV">
                                    </div>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="upiOption"
                                        value="1">
                                    <label class="form-check-label" for="upiOption">
                                        <strong>UPI</strong>
                                    </label>
                                    <div class="mt-2">
                                        <input type="text" class="form-control" placeholder="Enter UPI ID">
                                    </div>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="codOption"
                                        value="2">
                                    <label class="form-check-label" for="codOption">
                                        <strong>Cash on Delivery (COD)</strong>
                                    </label>
                                    <p class="mb-0">Pay when your order is delivered.</p>
                                </div>

                                <!-- Use this Payment Method Button -->
                                <div class="text-start">
                                    <button class="btn mt-3" id="submitPayment">Use this Payment Method</button>
                                </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Place Order Button -->
                <div class="form-group text-center mt-5">
                    <button class="btn btn-black btn-lg py-3" id="placeOrderButton">Place Order</button>
                </div>
            </div>
            <!-- hidden input to store selectd address -->
            <input type="hidden" id="selectedAddressId" name="selectedAddressId">
            <script>

    document.getElementById('submitPayment').addEventListener('click', function (e) {
    e.preventDefault(); // Prevent form submission
    const paymentMethodSelected = document.querySelector('input[name="paymentMethod"]:checked');

    if (!paymentMethodSelected) {
        Swal.fire({
            title: 'Error!',
            text: 'Please select a payment method before proceeding.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    } else {
        // Proceed with form submission
        document.getElementById('paymentForm').submit();
    }
});

document.getElementById('placeOrderButton').addEventListener('click', function(e) {
    e.preventDefault(); // Prevent default form submission
    placeOrderButton();
});

function placeOrderButton() {
    console.log("Place order button clicked");
    const addressRadio = document.querySelectorAll("input[name='selectedAddress']");
    const paymentOptions = document.querySelectorAll("input[name='paymentMethod']");
    
    let selectedAddressOption = null;
    let selectedPaymentOption = null;
    const defaultAddressId = '<%= defaultAddress ? defaultAddress._id : "null" %>';

    // Check if any address is selected
    for (let i = 0; i < addressRadio.length; i++) {
        if (addressRadio[i].checked) {
            selectedAddressOption = addressRadio[i].value;
            break;
        }
    }

    // Use default address if no address is selected
    if (!selectedAddressOption) {
        if (defaultAddressId === "null") {
            alert('Please select or add a delivery address.');
            return;
        } else {
            selectedAddressOption = defaultAddressId;
        }
    }

    // Check if a payment method is selected
    for (let i = 0; i < paymentOptions.length; i++) {
        if (paymentOptions[i].checked) {
            selectedPaymentOption = paymentOptions[i].value;
            break;
        }
    }

    // If no payment method is selected, stop the process
    if (!selectedPaymentOption) {
        alert('Please select a payment method.');
        return;
    }

    // Prepare order data
    const URL = `/placeOrder`;
    
    // Send the order details to the server
    fetch(URL, {
        method: 'POST',
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
        addressId: selectedAddressOption,
        paymentMethod: selectedPaymentOption,
    })
})

    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const orderId = data.orderId;
            // Redirect to success page or display order confirmation
            Swal.fire({
                title: 'Order Placed!',
                text: 'Your order has been successfully placed.',
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(() => {
                window.location.href = `/orderConfirmed/${orderId}`; // Redirect
            });
        } else {
            // Show error message
            Swal.fire({
                title: 'Error',
                text: 'There was an issue placing your order. Please try again.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: 'Error',
            text: 'An unexpected error occurred. Please try again later.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    });
}

console.log({
    addressId: selectedAddressOption,
    paymentMethod: selectedPaymentOption,
});

document.querySelector('.btn-close').addEventListener('click', function() {
    const modal = document.getElementById('addressModal');
    const modalInstance = bootstrap.Modal.getInstance(modal);
    if (modalInstance) {
        modalInstance.hide();
    }
});

let editingAddressId = null;

function editAddress(addressId) {
    // Find the address details from userAddress
    const addressToEdit = userAddress.address.find(addr => addr._id === addressId);
    
    // Populate the form with address details
    document.getElementById('fullName').value = addressToEdit.fullName;
    document.getElementById('addressLine1').value = addressToEdit.addressLine1;
    document.getElementById('addressLine2').value = addressToEdit.addressLine2;
    document.getElementById('city').value = addressToEdit.city;
    document.getElementById('state').value = addressToEdit.state;
    document.getElementById('country').value = addressToEdit.country;
    document.getElementById('pincode').value = addressToEdit.pincode;
    document.getElementById('phoneNumber').value = addressToEdit.phoneNumber;

    // Show the form and change the button to 'Update'
    document.getElementById('formTitle').innerText = 'Edit Address';
    editingAddressId = addressId;
    document.getElementById('addressForm').style.display = 'block';
}

document.getElementById('saveAddressButton').addEventListener('click', function() {
    const addressData = {
        fullName: document.getElementById('fullName').value,
        addressLine1: document.getElementById('addressLine1').value,
        addressLine2: document.getElementById('addressLine2').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        country: document.getElementById('country').value,
        pincode: document.getElementById('pincode').value,
        phoneNumber: document.getElementById('phoneNumber').value,
    };

    if (editingAddressId) {
       
        fetch(`/updateAddress/${editingAddressId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(addressData),
        }).then(response => response.json()).then(data => {
            // Handle success or error
            if (data.success) {
                // Update UI accordingly and close modal
                Swal.fire('Updated!', 'Address updated successfully.', 'success');
                location.reload(); // Reload to reflect changes
            } else {
                Swal.fire('Error!', data.message, 'error');
            }
        });
    } else {
        
        fetch('/addAddress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(addressData),
        }).then(response => response.json()).then(data => {
            // Handle success or error
            if (data.success) {
                Swal.fire('Added!', 'Address added successfully.', 'success');
                location.reload(); // Reload to reflect changes
            } else {
                Swal.fire('Error!', data.message, 'error');
            }
        });
    }
});

function confirmAddressSelection() {
    const addressRadio = document.querySelectorAll("input[name='selectedAddress']");
    let selectedAddressOption = null;

    // Find the selected address
    for (let i = 0; i < addressRadio.length; i++) {
        if (addressRadio[i].checked) {
            selectedAddressOption = addressRadio[i].value;
            break;
        }
    }

    if (selectedAddressOption) {
        // Store the selected address for later use
        document.getElementById('selectedAddressId').value = selectedAddressOption;

        // Close the modal
        const modal = document.getElementById('addressModal');
        const modalInstance = bootstrap.Modal.getInstance(modal);
        modalInstance.hide();
    } else {
        alert('Please select an address.');
    }
}

</script>


                